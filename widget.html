<script>
    // Function to fetch and extract GIF URLs from avatars.css asynchronously
    async function getValidGifURLs() {
        try {
            const [response, notShownResponse] = await Promise.all([
                fetch('https://userpfp.github.io/UserPFP/import.css'),
                fetch(''),
            ]);

            const [cssText, notShownText] = await Promise.all([
                response.text(),
                notShownResponse.text(),
            ]);

            const gifRegex = /url\(["']?(https:\/\/.+?\.gif)["']?\)/g;
            let match;
            const gifURLs = [];

            while ((match = gifRegex.exec(cssText)) !== null) {
                const gifURL = match[1];
                if (!isBadgeOrServerIcon(gifURL) && !notShownText.includes(gifURL)) {
                    gifURLs.push(gifURL);
                }
            }

            return gifURLs;
        } catch (error) {
            console.error('Error fetching data:', error);
            return [];
        }
    }

    // Function to check if the given URL is a badge or server icon URL
    function isBadgeOrServerIcon(url) {
        return (
            url.includes("profileBadges") ||
            url.includes("profileBadge") ||
            url.includes("badges") ||
            url.includes("cdn.discordapp.com/icons/")
        );
    }

    // Function to shuffle the array elements in random order
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // Function to add moving image elements to the container with error handling
    function addMovingImagesToContainer(imageUrls, containerElement) {
        for (const imageUrl of imageUrls) {
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('moving-image-container');

            const imageElement = document.createElement('img');
            imageElement.classList.add('moving-image');

            // Set the image source
            imageElement.src = imageUrl;

            // Add an error event listener to handle image load errors
            imageElement.addEventListener('error', () => {
                // Remove the container if an error occurs
                containerElement.removeChild(imageContainer);

                // Load a new GIF to replace the one that didn't load
                const newIndex = Math.floor(Math.random() * gifURLs.length);
                const newImageUrl = gifURLs[newIndex];
                addMovingImagesToContainer([newImageUrl], containerElement);
            });

            imageContainer.appendChild(imageElement);
            containerElement.appendChild(imageContainer);
        }
    }

    // Function to create the dynamic background
    async function createDynamicBackground() {
        const containerElement = document.createElement('div');
        containerElement.classList.add('moving-container');
        document.body.appendChild(containerElement);

        const gifURLs = await getValidGifURLs();
        shuffleArray(gifURLs); // Shuffle the GIF URLs in random order

        const numGifsToShow = 6; // Change this value to display a different number of GIFs at a time
        const gifURLsToShow = gifURLs.slice(0, numGifsToShow);

        addMovingImagesToContainer(gifURLsToShow, containerElement);
    }

    // Create the dynamic background asynchronously
    createDynamicBackground();
</script>
